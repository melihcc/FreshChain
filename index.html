<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>FreshChain</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.10.0/dist/ethers.min.js"></script>
    <style>
        body { font-family: Arial; margin: 30px; }
        button { margin: 5px; padding: 6px 12px; }
        input { margin: 5px; }
        .box { border: 1px solid #ccc; padding: 10px; margin-top: 15px; }
    </style>
</head>
<body>

<h2>FreshChain â€“ Blockchain Food Traceability</h2>

<button onclick="connect()">ðŸ”Œ Connect MetaMask</button>
<p id="account"></p>

<hr>

<h3>Select Role</h3>
<select id="role" onchange="showMenu()">
    <option value="">-- Select --</option>
    <option value="admin">Admin</option>
    <option value="producer">Producer</option>
    <option value="transporter">Transporter</option>
    <option value="distributor">Distributor</option>
    <option value="retailer">Retailer</option>
    <option value="customer">Customer</option>
</select>

<div id="menu"></div>

<script>
let provider, signer, contract;

// ðŸ”´ BURAYI GÃœNCELLE
const CONTRACT_ADDRESS = "0xf4F096e21D38709683bdFe861BC8A198582021bd";
const ABI = [
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "batchId",
				"type": "uint256"
			},
			{
				"internalType": "int256",
				"name": "temperature",
				"type": "int256"
			},
			{
				"internalType": "int256",
				"name": "humidity",
				"type": "int256"
			},
			{
				"internalType": "string",
				"name": "location",
				"type": "string"
			}
		],
		"name": "addSensorData",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"stateMutability": "nonpayable",
		"type": "constructor"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "batchId",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "bool",
				"name": "passedInspection",
				"type": "bool"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "retailer",
				"type": "address"
			}
		],
		"name": "ArrivedMarked",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "batchId",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "string",
				"name": "productName",
				"type": "string"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "quantity",
				"type": "uint256"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "producer",
				"type": "address"
			}
		],
		"name": "BatchCreated",
		"type": "event"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "batchId",
				"type": "uint256"
			},
			{
				"internalType": "string",
				"name": "productName",
				"type": "string"
			},
			{
				"internalType": "uint256",
				"name": "quantity",
				"type": "uint256"
			}
		],
		"name": "createBatch",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "distributor",
				"type": "address"
			}
		],
		"name": "DistributorRegistered",
		"type": "event"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "batchId",
				"type": "uint256"
			},
			{
				"internalType": "bool",
				"name": "passedInspection",
				"type": "bool"
			}
		],
		"name": "markAsArrived",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "batchId",
				"type": "uint256"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "from",
				"type": "address"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "to",
				"type": "address"
			}
		],
		"name": "OwnershipTransferred",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "producer",
				"type": "address"
			}
		],
		"name": "ProducerRegistered",
		"type": "event"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "distributor",
				"type": "address"
			}
		],
		"name": "registerDistributor",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "producer",
				"type": "address"
			}
		],
		"name": "registerProducer",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "retailer",
				"type": "address"
			}
		],
		"name": "registerRetailer",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "transporter",
				"type": "address"
			}
		],
		"name": "registerTransporter",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "retailer",
				"type": "address"
			}
		],
		"name": "RetailerRegistered",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "batchId",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "int256",
				"name": "temperature",
				"type": "int256"
			},
			{
				"indexed": false,
				"internalType": "int256",
				"name": "humidity",
				"type": "int256"
			},
			{
				"indexed": false,
				"internalType": "string",
				"name": "location",
				"type": "string"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "transporter",
				"type": "address"
			}
		],
		"name": "SensorDataAdded",
		"type": "event"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "batchId",
				"type": "uint256"
			},
			{
				"internalType": "address",
				"name": "newOwner",
				"type": "address"
			}
		],
		"name": "transferOwnership",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "transporter",
				"type": "address"
			}
		],
		"name": "TransporterRegistered",
		"type": "event"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "batchId",
				"type": "uint256"
			}
		],
		"name": "getBatchBasic",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "id",
				"type": "uint256"
			},
			{
				"internalType": "string",
				"name": "productName",
				"type": "string"
			},
			{
				"internalType": "uint256",
				"name": "quantity",
				"type": "uint256"
			},
			{
				"internalType": "address",
				"name": "producer",
				"type": "address"
			},
			{
				"internalType": "address",
				"name": "currentOwner",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "createdAt",
				"type": "uint256"
			},
			{
				"internalType": "bool",
				"name": "arrived",
				"type": "bool"
			},
			{
				"internalType": "bool",
				"name": "passedInspection",
				"type": "bool"
			},
			{
				"internalType": "uint256",
				"name": "inspectionTime",
				"type": "uint256"
			},
			{
				"internalType": "address",
				"name": "retailer",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "batchId",
				"type": "uint256"
			}
		],
		"name": "getBatchCounts",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "sensorCount",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "transferCount",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "batchId",
				"type": "uint256"
			}
		],
		"name": "getBatchHistory",
		"outputs": [
			{
				"components": [
					{
						"internalType": "int256",
						"name": "temperature",
						"type": "int256"
					},
					{
						"internalType": "int256",
						"name": "humidity",
						"type": "int256"
					},
					{
						"internalType": "string",
						"name": "location",
						"type": "string"
					},
					{
						"internalType": "uint256",
						"name": "timestamp",
						"type": "uint256"
					},
					{
						"internalType": "address",
						"name": "recorder",
						"type": "address"
					}
				],
				"internalType": "struct FreshChain.SensorData[]",
				"name": "sensorLogs",
				"type": "tuple[]"
			},
			{
				"components": [
					{
						"internalType": "address",
						"name": "from",
						"type": "address"
					},
					{
						"internalType": "address",
						"name": "to",
						"type": "address"
					},
					{
						"internalType": "uint256",
						"name": "timestamp",
						"type": "uint256"
					},
					{
						"internalType": "address",
						"name": "caller",
						"type": "address"
					}
				],
				"internalType": "struct FreshChain.TransferRecord[]",
				"name": "transfers",
				"type": "tuple[]"
			},
			{
				"components": [
					{
						"internalType": "bool",
						"name": "arrived",
						"type": "bool"
					},
					{
						"internalType": "bool",
						"name": "passedInspection",
						"type": "bool"
					},
					{
						"internalType": "uint256",
						"name": "timestamp",
						"type": "uint256"
					},
					{
						"internalType": "address",
						"name": "retailer",
						"type": "address"
					}
				],
				"internalType": "struct FreshChain.Inspection",
				"name": "inspection",
				"type": "tuple"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"name": "isDistributor",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"name": "isProducer",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"name": "isRetailer",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"name": "isTransporter",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "owner",
		"outputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	}
];

async function connect() {
    if (!window.ethereum) {
        alert("MetaMask not found");
        return;
    }
    provider = new ethers.BrowserProvider(window.ethereum);
    signer = await provider.getSigner();
    contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);

    const addr = await signer.getAddress();
    document.getElementById("account").innerText = "Connected: " + addr;
}

function showMenu() {
    const role = document.getElementById("role").value;
    const menu = document.getElementById("menu");
    menu.innerHTML = "";

    if (role === "admin") {
        menu.innerHTML = `
        <div class="box">
            <h4>Register Roles</h4>
            <input id="addr" placeholder="Address">
            <button onclick="register('producer')">Producer</button>
            <button onclick="register('transporter')">Transporter</button>
            <button onclick="register('distributor')">Distributor</button>
            <button onclick="register('retailer')">Retailer</button>
        </div>`;
    }

    if (role === "producer") {
        menu.innerHTML = `
        <div class="box">
            <h4>Create Batch</h4>
            <input id="bid" placeholder="Batch ID">
            <input id="pname" placeholder="Product Name">
            <input id="qty" placeholder="Quantity">
            <button onclick="createBatch()">Create</button>
        </div>`;
    }

    if (role === "transporter") {
        menu.innerHTML = `
        <div class="box">
            <h4>Add Sensor Data</h4>
            <input id="sbid" placeholder="Batch ID">
            <input id="temp" placeholder="Temperature">
            <input id="hum" placeholder="Humidity">
            <input id="loc" placeholder="Location">
            <button onclick="addSensor()">Add</button>
        </div>`;
    }

    if (role === "distributor") {
        menu.innerHTML = `
        <div class="box">
            <h4>Transfer Ownership</h4>
            <input id="tbid" placeholder="Batch ID">
            <input id="newOwner" placeholder="New Owner Address">
            <button onclick="transfer()">Transfer</button>
        </div>`;
    }

    if (role === "retailer") {
        menu.innerHTML = `
        <div class="box">
            <h4>Final Inspection</h4>
            <input id="rbid" placeholder="Batch ID">
            <button onclick="arrived(true)">Passed</button>
            <button onclick="arrived(false)">Failed</button>
        </div>`;
    }

    if (role === "customer") {
        menu.innerHTML = `
        <div class="box">
            <h4>View Batch History</h4>
            <input id="cbid" placeholder="Batch ID">
            <button onclick="view()">View</button>
            <pre id="output"></pre>
        </div>`;
    }
}

// ---- Contract Calls ----

async function register(type) {
    const addr = document.getElementById("addr").value;
    if (type === "producer") await contract.registerProducer(addr);
    if (type === "transporter") await contract.registerTransporter(addr);
    if (type === "distributor") await contract.registerDistributor(addr);
    if (type === "retailer") await contract.registerRetailer(addr);
    alert("Registered");
}

async function createBatch() {
    await contract.createBatch(
        bid.value,
        pname.value,
        qty.value
    );
    alert("Batch created");
}

async function addSensor() {
    await contract.addSensorData(
        sbid.value,
        temp.value,
        hum.value,
        loc.value
    );
    alert("Sensor data added");
}

async function transfer() {
    await contract.transferOwnership(
        tbid.value,
        newOwner.value
    );
    alert("Transferred");
}

async function arrived(pass) {
    await contract.markAsArrived(
        rbid.value,
        pass
    );
    alert("Marked");
}

async function view() {
    const history = await contract.getBatchHistory(cbid.value);
    document.getElementById("output").innerText =
        JSON.stringify(history, null, 2);
}
</script>

</body>
</html>
