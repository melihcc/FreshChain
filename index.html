<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>FreshChain</title>

<!-- ethers v5 (stable for GitHub Pages) -->
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

<style>
body{font-family:Arial;margin:28px}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
button{padding:8px 12px;cursor:pointer}
input,select{padding:8px;min-width:220px}
.card{border:1px solid #ddd;border-radius:10px;padding:14px;margin-top:14px}
.muted{color:#666;font-size:13px}
pre{white-space:pre-wrap;background:#f7f7f7;padding:10px;border-radius:8px}
.ok{color:#0a7a0a;font-weight:600}
.err{color:#b00020;font-weight:600}
img{max-width:220px}
</style>
</head>

<body>

<h2>FreshChain â€“ Blockchain Food Traceability</h2>

<div class="card">
  <div class="row">
    <button id="btnConnect">ðŸ”Œ MetaMask Connect</button>
    <button id="btnDisconnect">â›” Disconnect</button>
    <span id="net" class="muted"></span>
  </div>
  <div class="row" style="margin-top:10px">
    <div><b>Account:</b> <span id="account" class="muted">Not connected</span></div>
    <div><b>Status:</b> <span id="status" class="muted">â€”</span></div>
  </div>
</div>

<div class="card">
<h3>Role Select</h3>
<div class="row">
<select id="role">
<option value="">-- Select --</option>
<option value="admin">Admin</option>
<option value="producer">Producer</option>
<option value="transporter">Transporter</option>
<option value="distributor">Distributor</option>
<option value="retailer">Retailer</option>
<option value="customer">Customer</option>
</select>
<button id="btnShow">Show Menu</button>
</div>
<div id="menu"></div>
</div>

<div class="card">
<h3>Output</h3>
<pre id="out">â€”</pre>
</div>

<script>
/* ================= CONFIG ================= */
const CONTRACT_ADDRESS="0xf4F096e21D38709683bdFe861BC8A198582021bd";

/* ===== FULL ABI ===== */
const ABI=[
{"inputs":[{"internalType":"uint256","name":"batchId","type":"uint256"},{"internalType":"int256","name":"temperature","type":"int256"},{"internalType":"int256","name":"humidity","type":"int256"},{"internalType":"string","name":"location","type":"string"}],"name":"addSensorData","outputs":[],"stateMutability":"nonpayable","type":"function"},
{"inputs":[],"stateMutability":"nonpayable","type":"constructor"},
{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"batchId","type":"uint256"},{"indexed":false,"internalType":"bool","name":"passedInspection","type":"bool"},{"indexed":true,"internalType":"address","name":"retailer","type":"address"}],"name":"ArrivedMarked","type":"event"},
{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"batchId","type":"uint256"},{"indexed":false,"internalType":"string","name":"productName","type":"string"},{"indexed":false,"internalType":"uint256","name":"quantity","type":"uint256"},{"indexed":true,"internalType":"address","name":"producer","type":"address"}],"name":"BatchCreated","type":"event"},
{"inputs":[{"internalType":"uint256","name":"batchId","type":"uint256"},{"internalType":"string","name":"productName","type":"string"},{"internalType":"uint256","name":"quantity","type":"uint256"}],"name":"createBatch","outputs":[],"stateMutability":"nonpayable","type":"function"},
{"inputs":[{"internalType":"address","name":"distributor","type":"address"}],"name":"registerDistributor","outputs":[],"stateMutability":"nonpayable","type":"function"},
{"inputs":[{"internalType":"address","name":"producer","type":"address"}],"name":"registerProducer","outputs":[],"stateMutability":"nonpayable","type":"function"},
{"inputs":[{"internalType":"address","name":"retailer","type":"address"}],"name":"registerRetailer","outputs":[],"stateMutability":"nonpayable","type":"function"},
{"inputs":[{"internalType":"address","name":"transporter","type":"address"}],"name":"registerTransporter","outputs":[],"stateMutability":"nonpayable","type":"function"},
{"inputs":[{"internalType":"uint256","name":"batchId","type":"uint256"},{"internalType":"bool","name":"passedInspection","type":"bool"}],"name":"markAsArrived","outputs":[],"stateMutability":"nonpayable","type":"function"},
{"inputs":[{"internalType":"uint256","name":"batchId","type":"uint256"},{"internalType":"address","name":"newOwner","type":"address"}],"name":"transferOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},
{"inputs":[{"internalType":"uint256","name":"batchId","type":"uint256"}],"name":"getBatchBasic","outputs":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"string","name":"productName","type":"string"},{"internalType":"uint256","name":"quantity","type":"uint256"},{"internalType":"address","name":"producer","type":"address"},{"internalType":"address","name":"currentOwner","type":"address"},{"internalType":"uint256","name":"createdAt","type":"uint256"},{"internalType":"bool","name":"arrived","type":"bool"},{"internalType":"bool","name":"passedInspection","type":"bool"},{"internalType":"uint256","name":"inspectionTime","type":"uint256"},{"internalType":"address","name":"retailer","type":"address"}],"stateMutability":"view","type":"function"},
{"inputs":[{"internalType":"uint256","name":"batchId","type":"uint256"}],"name":"getBatchHistory","outputs":[{"components":[{"internalType":"int256","name":"temperature","type":"int256"},{"internalType":"int256","name":"humidity","type":"int256"},{"internalType":"string","name":"location","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"address","name":"recorder","type":"address"}],"internalType":"struct FreshChain.SensorData[]","name":"sensorLogs","type":"tuple[]"},{"components":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"address","name":"caller","type":"address"}],"internalType":"struct FreshChain.TransferRecord[]","name":"transfers","type":"tuple[]"},{"components":[{"internalType":"bool","name":"arrived","type":"bool"},{"internalType":"bool","name":"passedInspection","type":"bool"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"address","name":"retailer","type":"address"}],"internalType":"struct FreshChain.Inspection","name":"inspection","type":"tuple"}],"stateMutability":"view","type":"function"}
];

/* ============ GLOBAL ============ */
let provider,signer,contract;
const out=document.getElementById("out");
const statusEl=document.getElementById("status");
const accountEl=document.getElementById("account");
const netEl=document.getElementById("net");

function log(m,e=false){
out.textContent=m;
statusEl.textContent=e?"Error":"OK";
statusEl.className=e?"err":"ok";
}

/* ============ METAMASK ============ */
async function connectMM(){
try{
provider=new ethers.providers.Web3Provider(window.ethereum,"any");
await provider.send("eth_requestAccounts",[]);
signer=provider.getSigner();
contract=new ethers.Contract(CONTRACT_ADDRESS,ABI,signer);
accountEl.textContent=await signer.getAddress();
const n=await provider.getNetwork();
netEl.textContent=`Network: ${n.name} (${n.chainId})`;
log("Connected");
}catch(e){log(e.message,true);}
}
function disconnectMM(){
provider=signer=contract=null;
accountEl.textContent="Not connected";
netEl.textContent="";
log("Disconnected");
}

/* ============ MENU ============ */
function renderMenu(){
const r=role.value;
menu.innerHTML="";
if(r==="customer"){
menu.innerHTML=`
<div class="card">
<h4>Customer â€“ Public Verification</h4>
<div class="row">
<input id="cbid" placeholder="Batch ID">
<button onclick="viewHistory()">Get History</button>
</div>
<div style="margin-top:14px">
<h4>Verification QR</h4>
<img id="qrImage"/>
<div class="muted">Scan without MetaMask</div>
</div>
</div>`;
}
}

/* ============ QR ============ */
function generateQR(id){
const url=`https://melihcc.github.io/FreshChain/history.html?batchId=${id}`;
document.getElementById("qrImage").src=
"https://api.qrserver.com/v1/create-qr-code/?size=200x200&data="+encodeURIComponent(url);
}

/* ============ HISTORY ============ */
async function viewHistory(){
try{
const id=cbid.value.trim();
const res=await contract.getBatchHistory(ethers.BigNumber.from(id));
log(JSON.stringify(res,null,2));
generateQR(id);
}catch(e){log(e.message,true);}
}

/* ============ EVENTS ============ */
btnConnect.onclick=connectMM;
btnDisconnect.onclick=disconnectMM;
btnShow.onclick=renderMenu;

</script>
</body>
</html>
