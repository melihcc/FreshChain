<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FreshChain</title>

  <!-- âœ… Ethers v5 UMD (GitHub Pages + MetaMask iÃ§in en stabil) -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

  <style>
    body { font-family: Arial, sans-serif; margin: 28px; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    button { padding: 8px 12px; cursor:pointer; }
    input, select { padding: 8px; min-width: 240px; }
    .card { border:1px solid #ddd; border-radius:10px; padding:14px; margin-top:14px; }
    .muted { color:#666; font-size: 13px; }
    pre { white-space: pre-wrap; background:#f7f7f7; padding:10px; border-radius:8px; overflow:auto; }
    .ok { color: #0a7a0a; font-weight: 600; }
    .err { color: #b00020; font-weight: 600; }
  </style>
</head>

<body>
  <h2>FreshChain â€“ Food Traceability</h2>

  <div class="card">
    <div class="row">
      <button id="btnConnect">ðŸ”Œ MetaMask Connect</button>
      <button id="btnDisconnect">â›” Disconnect</button>
      <span id="net" class="muted"></span>
    </div>
    <div class="row" style="margin-top:10px;">
      <div><b>Account:</b> <span id="account" class="muted">Not connected</span></div>
      <div><b>Status:</b> <span id="status" class="muted">â€”</span></div>
    </div>
    <div class="muted" style="margin-top:10px;">
      Not: Sepoliaâ€™da deploy ettiysen MetaMask aÄŸÄ±nÄ± Sepolia seÃ§.
    </div>
  </div>

  <div class="card">
    <h3>Role Select</h3>
    <div class="row">
      <select id="role">
        <option value="">-- SeÃ§ --</option>
        <option value="admin">Admin</option>
        <option value="producer">Producer</option>
        <option value="transporter">Transporter</option>
        <option value="distributor">Distributor</option>
        <option value="retailer">Retailer</option>
        <option value="customer">Customer</option>
      </select>
      <button id="btnShow">ðŸ“Œ MenÃ¼ GÃ¶ster</button>
    </div>

    <div id="menu"></div>
  </div>

  <div class="card">
    <h3>Output</h3>
    <pre id="out">â€”</pre>
  </div>

<script>
/* =========================
   ðŸ”´ BURAYI DOLDUR
   ========================= */
const CONTRACT_ADDRESS = "0xf4F096e21D38709683bdFe861BC8A198582021bd";
const ABI = [
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "batchId",
				"type": "uint256"
			},
			{
				"internalType": "int256",
				"name": "temperature",
				"type": "int256"
			},
			{
				"internalType": "int256",
				"name": "humidity",
				"type": "int256"
			},
			{
				"internalType": "string",
				"name": "location",
				"type": "string"
			}
		],
		"name": "addSensorData",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"stateMutability": "nonpayable",
		"type": "constructor"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "batchId",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "bool",
				"name": "passedInspection",
				"type": "bool"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "retailer",
				"type": "address"
			}
		],
		"name": "ArrivedMarked",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "batchId",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "string",
				"name": "productName",
				"type": "string"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "quantity",
				"type": "uint256"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "producer",
				"type": "address"
			}
		],
		"name": "BatchCreated",
		"type": "event"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "batchId",
				"type": "uint256"
			},
			{
				"internalType": "string",
				"name": "productName",
				"type": "string"
			},
			{
				"internalType": "uint256",
				"name": "quantity",
				"type": "uint256"
			}
		],
		"name": "createBatch",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "distributor",
				"type": "address"
			}
		],
		"name": "DistributorRegistered",
		"type": "event"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "batchId",
				"type": "uint256"
			},
			{
				"internalType": "bool",
				"name": "passedInspection",
				"type": "bool"
			}
		],
		"name": "markAsArrived",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "batchId",
				"type": "uint256"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "from",
				"type": "address"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "to",
				"type": "address"
			}
		],
		"name": "OwnershipTransferred",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "producer",
				"type": "address"
			}
		],
		"name": "ProducerRegistered",
		"type": "event"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "distributor",
				"type": "address"
			}
		],
		"name": "registerDistributor",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "producer",
				"type": "address"
			}
		],
		"name": "registerProducer",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "retailer",
				"type": "address"
			}
		],
		"name": "registerRetailer",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "transporter",
				"type": "address"
			}
		],
		"name": "registerTransporter",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "retailer",
				"type": "address"
			}
		],
		"name": "RetailerRegistered",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "batchId",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "int256",
				"name": "temperature",
				"type": "int256"
			},
			{
				"indexed": false,
				"internalType": "int256",
				"name": "humidity",
				"type": "int256"
			},
			{
				"indexed": false,
				"internalType": "string",
				"name": "location",
				"type": "string"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "transporter",
				"type": "address"
			}
		],
		"name": "SensorDataAdded",
		"type": "event"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "batchId",
				"type": "uint256"
			},
			{
				"internalType": "address",
				"name": "newOwner",
				"type": "address"
			}
		],
		"name": "transferOwnership",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "transporter",
				"type": "address"
			}
		],
		"name": "TransporterRegistered",
		"type": "event"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "batchId",
				"type": "uint256"
			}
		],
		"name": "getBatchBasic",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "id",
				"type": "uint256"
			},
			{
				"internalType": "string",
				"name": "productName",
				"type": "string"
			},
			{
				"internalType": "uint256",
				"name": "quantity",
				"type": "uint256"
			},
			{
				"internalType": "address",
				"name": "producer",
				"type": "address"
			},
			{
				"internalType": "address",
				"name": "currentOwner",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "createdAt",
				"type": "uint256"
			},
			{
				"internalType": "bool",
				"name": "arrived",
				"type": "bool"
			},
			{
				"internalType": "bool",
				"name": "passedInspection",
				"type": "bool"
			},
			{
				"internalType": "uint256",
				"name": "inspectionTime",
				"type": "uint256"
			},
			{
				"internalType": "address",
				"name": "retailer",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "batchId",
				"type": "uint256"
			}
		],
		"name": "getBatchCounts",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "sensorCount",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "transferCount",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "batchId",
				"type": "uint256"
			}
		],
		"name": "getBatchHistory",
		"outputs": [
			{
				"components": [
					{
						"internalType": "int256",
						"name": "temperature",
						"type": "int256"
					},
					{
						"internalType": "int256",
						"name": "humidity",
						"type": "int256"
					},
					{
						"internalType": "string",
						"name": "location",
						"type": "string"
					},
					{
						"internalType": "uint256",
						"name": "timestamp",
						"type": "uint256"
					},
					{
						"internalType": "address",
						"name": "recorder",
						"type": "address"
					}
				],
				"internalType": "struct FreshChain.SensorData[]",
				"name": "sensorLogs",
				"type": "tuple[]"
			},
			{
				"components": [
					{
						"internalType": "address",
						"name": "from",
						"type": "address"
					},
					{
						"internalType": "address",
						"name": "to",
						"type": "address"
					},
					{
						"internalType": "uint256",
						"name": "timestamp",
						"type": "uint256"
					},
					{
						"internalType": "address",
						"name": "caller",
						"type": "address"
					}
				],
				"internalType": "struct FreshChain.TransferRecord[]",
				"name": "transfers",
				"type": "tuple[]"
			},
			{
				"components": [
					{
						"internalType": "bool",
						"name": "arrived",
						"type": "bool"
					},
					{
						"internalType": "bool",
						"name": "passedInspection",
						"type": "bool"
					},
					{
						"internalType": "uint256",
						"name": "timestamp",
						"type": "uint256"
					},
					{
						"internalType": "address",
						"name": "retailer",
						"type": "address"
					}
				],
				"internalType": "struct FreshChain.Inspection",
				"name": "inspection",
				"type": "tuple"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"name": "isDistributor",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"name": "isProducer",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"name": "isRetailer",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"name": "isTransporter",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "owner",
		"outputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	}
];; // Remix ABI JSON'i buraya yapÄ±ÅŸtÄ±r

/* =========================
   Global
   ========================= */
let provider = null;
let signer = null;
let contract = null;
let currentAccount = null;

const outEl = document.getElementById("out");
const statusEl = document.getElementById("status");
const accountEl = document.getElementById("account");
const netEl = document.getElementById("net");

function log(msg, isError=false) {
  outEl.textContent = msg;
  statusEl.textContent = isError ? "Error" : "OK";
  statusEl.className = isError ? "err" : "ok";
}

function ensureConnected() {
  if (!window.ethereum) throw new Error("MetaMask bulunamadÄ± (window.ethereum yok).");
  if (!provider || !signer || !contract) throw new Error("Ã–nce MetaMask Connect yapmalÄ±sÄ±n.");
}

/* =========================
   MetaMask Connect
   ========================= */
async function connectMM() {
  if (!window.ethereum) {
    log("MetaMask bulunamadÄ±. Chrome/Brave + MetaMask kullan.", true);
    return;
  }

  try {
    // âœ… v5: Web3Provider
    provider = new ethers.providers.Web3Provider(window.ethereum, "any");

    // âœ… account iste (pop-up)
    await provider.send("eth_requestAccounts", []);
    signer = provider.getSigner();

    currentAccount = await signer.getAddress();
    accountEl.textContent = currentAccount;

    // contract instance
    contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);

    const network = await provider.getNetwork();
    netEl.textContent = `Network: ${network.name} (chainId=${network.chainId})`;

    log("BaÄŸlandÄ± âœ…");
  } catch (e) {
    console.error(e);
    log("BaÄŸlantÄ± baÅŸarÄ±sÄ±z: " + (e?.message || e), true);
  }
}

function disconnectMM() {
  // MetaMask gerÃ§ek disconnect vermez; sadece local state temizlenir
  provider = null; signer = null; contract = null; currentAccount = null;
  accountEl.textContent = "Not connected";
  netEl.textContent = "";
  log("Disconnect (local) âœ…");
}

/* =========================
   Menu Render
   ========================= */
function renderMenu() {
  const role = document.getElementById("role").value;
  const menu = document.getElementById("menu");
  menu.innerHTML = "";

  if (!role) {
    menu.innerHTML = `<p class="muted">Ã–nce rol seÃ§.</p>`;
    return;
  }

  if (role === "admin") {
    menu.innerHTML = `
      <div class="card">
        <h4>Admin â€“ Register Roles</h4>
        <div class="row">
          <input id="addr" placeholder="0x... Address">
          <button onclick="registerRole('producer')">Register Producer</button>
          <button onclick="registerRole('transporter')">Register Transporter</button>
          <button onclick="registerRole('distributor')">Register Distributor</button>
          <button onclick="registerRole('retailer')">Register Retailer</button>
        </div>
        <div class="row" style="margin-top:10px;">
          <button onclick="checkRoles()">Check Role of Address</button>
        </div>
      </div>
    `;
  }

  if (role === "producer") {
    menu.innerHTML = `
      <div class="card">
        <h4>Producer â€“ Create Batch</h4>
        <div class="row">
          <input id="bid" placeholder="Batch ID (e.g. 101)">
          <input id="pname" placeholder='Product Name (e.g. "Tomatoes")'>
          <input id="qty" placeholder="Quantity (e.g. 100)">
          <button onclick="createBatch()">Create</button>
        </div>
      </div>
      <div class="card">
        <h4>Ownership Transfer</h4>
        <div class="row">
          <input id="tbid" placeholder="Batch ID">
          <input id="newOwner" placeholder="New Owner 0x...">
          <button onclick="transfer()">Transfer</button>
        </div>
      </div>
    `;
  }

  if (role === "transporter") {
    menu.innerHTML = `
      <div class="card">
        <h4>Transporter â€“ Add Sensor Data</h4>
        <div class="row">
          <input id="sbid" placeholder="Batch ID (e.g. 101)">
          <input id="temp" placeholder="Temperature (-10..40)">
          <input id="hum" placeholder="Humidity (0..40)">
          <input id="loc" placeholder='Location (e.g. "Bursa")'>
          <button onclick="addSensor()">Add</button>
        </div>
      </div>
      <div class="card">
        <h4>Ownership Transfer</h4>
        <div class="row">
          <input id="tbid" placeholder="Batch ID">
          <input id="newOwner" placeholder="New Owner 0x...">
          <button onclick="transfer()">Transfer</button>
        </div>
      </div>
    `;
  }

  if (role === "distributor") {
    menu.innerHTML = `
      <div class="card">
        <h4>Distributor â€“ Ownership Transfer</h4>
        <div class="row">
          <input id="tbid" placeholder="Batch ID">
          <input id="newOwner" placeholder="New Owner 0x...">
          <button onclick="transfer()">Transfer</button>
        </div>
      </div>
    `;
  }

  if (role === "retailer") {
    menu.innerHTML = `
      <div class="card">
        <h4>Retailer â€“ Final Inspection</h4>
        <div class="row">
          <input id="rbid" placeholder="Batch ID">
          <button onclick="markArrived(true)">Passed</button>
          <button onclick="markArrived(false)">Failed</button>
        </div>
      </div>
    `;
  }

  if (role === "customer") {
    menu.innerHTML = `
      <div class="card">
        <h4>Customer â€“ View History</h4>
        <div class="row">
          <input id="cbid" placeholder="Batch ID (e.g. 101)">
          <button onclick="viewBasic()">getBatchBasic</button>
          <button onclick="viewHistory()">getBatchHistory</button>
        </div>
      </div>
    `;
  }
}

/* =========================
   Contract Calls
   ========================= */

async function waitTx(tx) {
  log("Tx sent: " + tx.hash + "\nBekleniyor...");
  const rcpt = await tx.wait();
  log("âœ… Mined: " + tx.hash + "\nBlock: " + rcpt.blockNumber);
  return rcpt;
}

async function registerRole(type) {
  try {
    ensureConnected();
    const addr = document.getElementById("addr").value.trim();
    if (!addr) throw new Error("Address boÅŸ.");

    let tx;
    if (type === "producer") tx = await contract.registerProducer(addr);
    if (type === "transporter") tx = await contract.registerTransporter(addr);
    if (type === "distributor") tx = await contract.registerDistributor(addr);
    if (type === "retailer") tx = await contract.registerRetailer(addr);

    await waitTx(tx);
  } catch (e) {
    console.error(e);
    log("Register error: " + (e?.message || e), true);
  }
}

async function checkRoles() {
  try {
    ensureConnected();
    const addr = document.getElementById("addr").value.trim();
    if (!addr) throw new Error("Address boÅŸ.");

    const p = await contract.isProducer(addr);
    const t = await contract.isTransporter(addr);
    const d = await contract.isDistributor(addr);
    const r = await contract.isRetailer(addr);

    log(JSON.stringify({ address: addr, isProducer: p, isTransporter: t, isDistributor: d, isRetailer: r }, null, 2));
  } catch (e) {
    console.error(e);
    log("Check role error: " + (e?.message || e), true);
  }
}

async function createBatch() {
  try {
    ensureConnected();
    const bid = document.getElementById("bid").value.trim();
    const pname = document.getElementById("pname").value.trim();
    const qty = document.getElementById("qty").value.trim();

    const tx = await contract.createBatch(
      ethers.BigNumber.from(bid),
      pname,
      ethers.BigNumber.from(qty)
    );
    await waitTx(tx);
  } catch (e) {
    console.error(e);
    log("createBatch error: " + (e?.message || e), true);
  }
}

async function addSensor() {
  try {
    ensureConnected();
    const sbid = document.getElementById("sbid").value.trim();
    const temp = document.getElementById("temp").value.trim();
    const hum = document.getElementById("hum").value.trim();
    const loc = document.getElementById("loc").value.trim();

    const tx = await contract.addSensorData(
      ethers.BigNumber.from(sbid),
      parseInt(temp, 10),
      parseInt(hum, 10),
      loc
    );
    await waitTx(tx);
  } catch (e) {
    console.error(e);
    log("addSensorData error: " + (e?.message || e), true);
  }
}

async function transfer() {
  try {
    ensureConnected();
    const tbid = document.getElementById("tbid").value.trim();
    const newOwner = document.getElementById("newOwner").value.trim();

    const tx = await contract.transferOwnership(
      ethers.BigNumber.from(tbid),
      newOwner
    );
    await waitTx(tx);
  } catch (e) {
    console.error(e);
    log("transferOwnership error: " + (e?.message || e), true);
  }
}

async function markArrived(pass) {
  try {
    ensureConnected();
    const rbid = document.getElementById("rbid").value.trim();

    const tx = await contract.markAsArrived(
      ethers.BigNumber.from(rbid),
      pass
    );
    await waitTx(tx);
  } catch (e) {
    console.error(e);
    log("markAsArrived error: " + (e?.message || e), true);
  }
}

async function viewBasic() {
  try {
    if (!window.ethereum) throw new Error("MetaMask yok.");
    // Customer view iÃ§in de MetaMask Ã¼zerinden okuyoruz (kolay)
    ensureConnected();

    const cbid = document.getElementById("cbid").value.trim();
    const res = await contract.getBatchBasic(ethers.BigNumber.from(cbid));

    // ethers v5 return: array-like object
    const obj = {
      batchId: res[0].toString(),
      productName: res[1],
      quantity: res[2].toString(),
      producer: res[3],
      currentOwner: res[4],
      createdAt: res[5].toString(),
      arrived: res[6],
      passedInspection: res[7],
      inspectionTime: res[8].toString(),
      retailer: res[9]
    };

    log(JSON.stringify(obj, null, 2));
  } catch (e) {
    console.error(e);
    log("getBatchBasic error: " + (e?.message || e), true);
  }
}

async function viewHistory() {
  try {
    ensureConnected();
    const cbid = document.getElementById("cbid").value.trim();

    const res = await contract.getBatchHistory(ethers.BigNumber.from(cbid));
    // res = [sensorLogs, transfers, inspection]
    log(JSON.stringify(res, null, 2));
  } catch (e) {
    console.error(e);
    log("getBatchHistory error: " + (e?.message || e), true);
  }
}

/* =========================
   Event Listeners
   ========================= */
document.getElementById("btnConnect").addEventListener("click", connectMM);
document.getElementById("btnDisconnect").addEventListener("click", disconnectMM);
document.getElementById("btnShow").addEventListener("click", renderMenu);

// Hesap/aÄŸ deÄŸiÅŸince UI yenile
if (window.ethereum) {
  window.ethereum.on("accountsChanged", () => {
    disconnectMM();
    log("Account changed. Tekrar connect yap.", false);
  });
  window.ethereum.on("chainChanged", () => {
    disconnectMM();
    log("Network changed. Tekrar connect yap.", false);
  });
}
</script>
</body>
</html>
